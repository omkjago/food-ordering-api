<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Restoran - FoodOrder</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow p-4 flex flex-col">
      <div class="text-orange-600 font-bold text-xl mb-4">üç¥ FoodOrder</div>
      <nav class="flex-1 space-y-2">
        <button onclick="Dashboard()" class="block py-2 px-3 rounded bg-gray-200">Dashboard</button>
        <button onclick="Produk()" class="block py-2 px-3 rounded hover:bg-gray-200">Produk</button>
        <a href="#" class="block py-2 px-3 rounded hover:bg-gray-200">Kategori</a>
        <a href="#" class="block py-2 px-3 rounded hover:bg-gray-200">Pelanggan</a>
        <a href="#" class="block py-2 px-3 rounded hover:bg-gray-200">Pesanan</a>
        <a href="#" class="block py-2 px-3 rounded hover:bg-gray-200">Pembayaran</a>
        <a href="#" class="block py-2 px-3 rounded hover:bg-gray-200">Notifikasi</a>
        <a href="#" class="block py-2 px-3 rounded hover:bg-gray-200">Pengaturan</a>
      </nav>
      <div class="mt-4 text-sm text-gray-500">
        <div class="font-bold" id="admin-name">Admin</div>
        <div id="admin-email">admin@foodorder.com</div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Dashboard Restoran</h1>
        <div class="relative">
          <input type="text" placeholder="Cari..." class="border rounded px-3 py-1">
        </div>
      </div>

      <!-- Statistik Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-4 rounded shadow">
          <div class="text-gray-500">Total Pendapatan</div>
          <div class="text-2xl font-bold" id="total-pendapatan">Loading...</div>
          <div class="text-sm" id="pendapatan-persentase">Menghitung...</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <div class="text-gray-500">Pesanan Baru</div>
          <div class="text-2xl font-bold" id="pesanan-baru">Loading...</div>
          <div class="text-sm" id="pesanan-persentase">Menghitung...</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <div class="text-gray-500">Pelanggan Baru</div>
          <div class="text-2xl font-bold" id="pelanggan-baru">Loading...</div>
          <div class="text-sm" id="pelanggan-persentase">Menghitung...</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <div class="text-gray-500">Produk Terjual</div>
          <div class="text-2xl font-bold" id="produk-terjual">Loading...</div>
          <div class="text-sm" id="produk-persentase">Menghitung...</div>
        </div>
      </div>

      <!-- Produk Populer -->
      <div class="bg-white p-4 rounded shadow mb-6">
        <h2 class="text-lg font-bold mb-4">Produk Populer</h2>
        <ul class="space-y-2" id="produk-populer-list">
          <li class="text-center py-4">Loading produk populer...</li>
        </ul>
      </div>

      <!-- Pesanan Terbaru -->
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-bold mb-4">Pesanan Terbaru</h2>
        <table class="w-full table-auto text-left">
          <thead>
            <tr class="text-gray-600">
              <th class="py-2">ID Pesanan</th>
              <th>Pelanggan</th>
              <th>Tanggal</th>
              <th>Jumlah Produk</th>
              <th>Total</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="pesanan-terbaru-table">
            <tr>
              <td colspan="6" class="text-center py-4">Loading data pesanan...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('token');
      
      if (!token) {
        window.location.href = 'login.html';
        return;
      }
      
      // Fungsi untuk format mata uang Rupiah
      function formatRupiah(angka) {
        return 'Rp ' + new Intl.NumberFormat('id-ID').format(angka);
      }
      
      // Fungsi untuk format tanggal Indonesia
      function formatTanggal(dateString) {
        const date = new Date(dateString);
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        return date.toLocaleDateString('id-ID', options);
      }
      
      // Dapatkan data admin
      fetch('/api/user', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to fetch admin data');
        return response.json();
      })
      .then(data => {
        document.getElementById('admin-name').textContent = data.name;
        document.getElementById('admin-email').textContent = data.email;
      })
      .catch(error => {
        console.error('Error fetching admin data:', error);
      });
      
      // Dapatkan statistik dashboard
      fetch('/api/admin/statistics', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to fetch statistics');
        return response.json();
      })
      .then(data => {
        // Total Pendapatan
        document.getElementById('total-pendapatan').textContent = formatRupiah(data.pendapatan.current);
        const persentasePendapatan = ((data.pendapatan.current - data.pendapatan.previous) / data.pendapatan.previous * 100).toFixed(1);
        const pendapatanElement = document.getElementById('pendapatan-persentase');
        pendapatanElement.textContent = `${persentasePendapatan}% dari bulan lalu`;
        if (persentasePendapatan > 0) {
          pendapatanElement.classList.add('text-green-500');
        } else {
          pendapatanElement.classList.add('text-red-500');
        }
        
        // Pesanan Baru
        document.getElementById('pesanan-baru').textContent = `+${data.pesanan.current}`;
        const persentasePesanan = ((data.pesanan.current - data.pesanan.previous) / data.pesanan.previous * 100).toFixed(1);
        const pesananElement = document.getElementById('pesanan-persentase');
        pesananElement.textContent = `${persentasePesanan}% dari bulan lalu`;
        if (persentasePesanan > 0) {
          pesananElement.classList.add('text-green-500');
        } else {
          pesananElement.classList.add('text-red-500');
        }
        
        // Pelanggan Baru
        document.getElementById('pelanggan-baru').textContent = `+${data.pelanggan.current}`;
        const persentasePelanggan = ((data.pelanggan.current - data.pelanggan.previous) / data.pelanggan.previous * 100).toFixed(1);
        const pelangganElement = document.getElementById('pelanggan-persentase');
        pelangganElement.textContent = `${persentasePelanggan}% dari bulan lalu`;
        if (persentasePelanggan > 0) {
          pelangganElement.classList.add('text-green-500');
        } else {
          pelangganElement.classList.add('text-red-500');
        }
        
        // Produk Terjual
        document.getElementById('produk-terjual').textContent = data.produk.current;
        const persentaseProduk = ((data.produk.current - data.produk.previous) / data.produk.previous * 100).toFixed(1);
        const produkElement = document.getElementById('produk-persentase');
        produkElement.textContent = `${persentaseProduk}% dari bulan lalu`;
        if (persentaseProduk > 0) {
          produkElement.classList.add('text-green-500');
        } else {
          produkElement.classList.add('text-red-500');
        }
      })
      .catch(error => {
        console.error('Error fetching statistics:', error);
        document.getElementById('total-pendapatan').textContent = 'Error';
        document.getElementById('pesanan-baru').textContent = 'Error';
        document.getElementById('pelanggan-baru').textContent = 'Error';
        document.getElementById('produk-terjual').textContent = 'Error';
      });
      
       // Dapatkan produk populer
       fetch('/api/admin/popular-products', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to fetch popular products');
        return response.json();
      })
      .then(data => {
        const productsContainer = document.getElementById('produk-populer-list');
        productsContainer.innerHTML = '';
        
        data.forEach(product => {
          const trendIcon = product.trend > 0 ? 
            '<span class="text-green-500">‚Üë</span>' : 
            '<span class="text-red-500">‚Üì</span>';
          
          const listItem = document.createElement('li');
          listItem.className = 'flex justify-between';
          listItem.innerHTML = `
            <span>${product.nama} <span class="text-sm text-gray-500">(${product.kategori})</span></span>
            <span>${product.jumlah_terjual} ${trendIcon}</span>
          `;
          
          productsContainer.appendChild(listItem);
        });
      })
      .catch(error => {
        console.error('Error fetching popular products:', error);
        document.getElementById('produk-populer-list').innerHTML = 
          '<li class="text-center py-2 text-red-500">Gagal memuat produk populer</li>';
      });
      
      // Dapatkan pesanan terbaru
fetch('/api/admin/recent-orders', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(response => {
  if (!response.ok) throw new Error('Failed to fetch recent orders');
  return response.json();
})
.then(data => {
  const tableBody = document.getElementById('pesanan-terbaru-table');
  tableBody.innerHTML = '';
  
  if (data.length === 0) {
    const emptyRow = document.createElement('tr');
    emptyRow.className = 'border-t';
    emptyRow.innerHTML = `
      <td colspan="6" class="text-center py-4">Tidak ada pesanan terbaru</td>
    `;
    tableBody.appendChild(emptyRow);
    return;
  }
  
  data.forEach(order => {
    let statusClass = '';
    switch (order.status.toLowerCase()) {
      case 'selesai':
        statusClass = 'text-green-600';
        break;
      case 'aktif':
        statusClass = 'text-blue-600';
        break;
      case 'pending':
        statusClass = 'text-yellow-600';
        break;
      default:
        statusClass = 'text-gray-600';
    }
    
    const row = document.createElement('tr');
    row.className = 'border-t';
    row.innerHTML = `
      <td>#ORD-${order.id}</td>
      <td>${order.pelanggan_nama}</td>
      <td>${formatTanggal(order.tanggal)}</td>
      <td>${order.jumlah_produk}</td>
      <td>${formatRupiah(order.total)}</td>
      <td><span class="${statusClass} font-semibold">${order.status}</span></td>
    `;
    
    tableBody.appendChild(row);
  });
})
.catch(error => {
  console.error('Error fetching recent orders:', error);
  document.getElementById('pesanan-terbaru-table').innerHTML = `
    <tr class="border-t">
      <td colspan="6" class="text-center py-2 text-red-500">Gagal memuat data pesanan</td>
    </tr>
  `;
});
    });

    function Dashboard() {
      window.location.href = `dashboard_admin.html`;
    }
    
    function Produk() {
      window.location.href = `admin/admin-menu.html`;
    }
    
    function AdminValidasi() {
      window.location.href = `admin/admin-validasi.html`;
    }
  </script>
</body>
</html>
