<!DOCTYPE html>
<html lang="ID">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Menu - Food Ordering</title>
        <link
            href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
            rel="stylesheet" />
        <link href="css/style.css" rel="stylesheet" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet" />
    </head>
    <body
        class="bg-gray-100 menu-page min-h-screen flex flex-col justify-between py-8">
        <header class="mb-6 pb-4">
            <h2 class="text-4xl font-extrabold text-gray-800">Menu</h2>
        </header>
        <div id="sticky-filters-container" class="bg-white z-50">
            <div class="container mx-auto py-2"> <!-- Removed px-4 here -->
                <div class="mb-8 px-4"> <!-- Added px-4 here for consistent horizontal padding -->
                    <div class="relative">
                        <input type="text"
                            id="menu-search"
                            oninput="filterMenu(); toggleSearchIcon();" 
                            placeholder="Cari Menu"
                            class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <div
                            id="search-icon" 
                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"> <!-- Adjusted pl-3 -->
                            <svg
                                class="h-5 w-5 text-gray-400"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <section class="menu-filter-section mb-8 px-4"> <!-- Added px-4 here -->
                    <div
                        id="category-filters"
                        class="flex flex-nowrap overflow-x-auto justify-start gap-2 pb-4"></div>
                    <div
                        id="subcategory-filters"
                        class="flex flex-nowrap overflow-x-auto justify-start gap-2 pb-4"></div>
                </section>
            </div>
        </div>
        <div class="container bg-white p-8 rounded-lg shadow-xl w-full">
            <section class="promotions-section mb-8">
                <div class="promotions-content">
                    <h3>Today's offer</h3>
                    <p>Free box of Fries</p>
                    <p>on all orders above 1k</p>
                </div>
                <img
                src="/storage/image 9.png"
                    alt="Free Fries Promotion"
                    class="promotions-image" />
            </section>

            <section class="popular-menu-section mb-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 px-4">
                    Popular
                </h3>
                <div id="popular-menu-list" class="carousel px-4"></div>
            </section>

            <div id="grouped-menu-sections"></div>

            <div id="menu-detail-modal" class="modal">
                <div class="modal-content menu-detail-modal-content">
                    <button
                        onclick="closeMenuDetailModal()"
                        class="modal-close-button">
                        &times;
                    </button>
                    <div class="menu-detail-modal-image-container">
                        <img
                            id="modal-menu-image"
                            src
                            alt="Menu Item"
                            class="modal-menu-image" />
                    </div>
                    <div class="menu-detail-modal-body">
                        <div class="menu-detail-modal-header">
                            <div class="rating">
                                <i class="fas fa-star"></i> 4.8
                            </div>
                            <div class="price" id="modal-menu-price">Rp 0</div>
                        </div>
                        <h3 id="modal-menu-name">Nama Menu</h3>
                        <div class="quantity-control">
                            <button onclick="changeModalQty(-1)">-</button>
                            <span id="modal-menu-qty">1</span>
                            <button onclick="changeModalQty(1)">+</button>
                        </div>
                        <p id="modal-menu-description" class="description">
                            Deskripsi menu akan muncul di sini.
                        </p>

                        <div class="addons-section">
                            <h4>Add Ons</h4>
                            <div id="modal-addons-container"></div>
                        </div>

                        <div class="notes-section">
                            <h4>Order Notes</h4>
                            <textarea
                                id="modal-menu-notes"
                                placeholder="Tambahkan catatan khusus untuk pesanan ini (contoh: tidak pedas, tanpa bawang)..."></textarea>
                        </div>

                        <button
                            onclick="addCurrentItemToOrder()"
                            class="add-to-cart-button">
                            Add to Cart
                        </button>
                    </div>
                </div>
            </div>

            <div id="order-modal" class="modal">
                <div class="modal-content order-summary-modal-content">
                    <h3
                        class="mb-6 text-2xl font-bold text-gray-800 text-center">
                        Ringkasan Pesanan Anda
                    </h3>
                    <div id="order-summary" class="mb-4"></div>
                    <div
                        id="order-summary-note"
                        class="text-sm text-gray-600 mt-4 pt-4 border-t border-gray-200 text-center">
                        <p>
                            Klik
                            <strong class="font-semibold">Konfirmasi
                                Pesanan</strong>
                            untuk menyimpan pesanan dan melanjutkan pembayaran.
                        </p>
                        <p>
                            Klik
                            <strong class="font-semibold">Selesai</strong>
                            apabila masih ingin menambah menu.
                        </p>
                    </div>
                    <div
                        class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
                        <button
                            onclick="confirmOrderAndNavigate()"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-lg flex-grow">
                            Konfirmasi Pesanan
                        </button>
                        <button
                            onclick="closeModal()"
                            class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-lg flex-grow">
                            Selesai
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="fixed-order-summary" class="hidden">
            <span id="summary-text" class="flex-grow text-left"> </span>
            <button
                onclick="showOrderSummaryAndModal()"
                class="bg-white hover:bg-gray-100 text-blue-600 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md">
                Detail Pesanan
            </button>
        </div>

        <script>
            let order = [];
            let totalOrderAmount = 0;
            let allMenus = []; // Stores all fetched menus for filtering
            let allCategories = []; // Stores unique categories from menu data
            let allSubcategories = []; // Stores unique subcategories from menu data
            let currentFilteredMenus = []; // Menus currently displayed after category/search filter

            let currentMenuItem = null; // Stores the menu item currently viewed in the modal
            let currentModalQuantity = 1;
            let currentModalNotes = "";
            let currentModalAddons = []; // Stores selected add-ons for the current item in the modal

            let allAddons = []; // Stores all fetched add-ons

            // To store the IntersectionObserver instance
            let subcategoryObserver;
            let categoryObserver; // Observer for categories

            // Auto-slide for popular products
            let popularSliderInterval;
            let popularSliderPaused = false;
            let popularSliderCurrentPosition = 0; // Track current scroll position for popular carousel
            let popularSliderItemWidth = 0; // To store the width of a single popular menu card

            // --- Table Number Check ---
            async function checkTableNumber() {
                const urlParams = new URLSearchParams(window.location.search);
                const kodeBarcode = urlParams.get("");
                if (!kodeBarcode) {
                    alert(
                        "Nomor meja tidak ditemukan. Silakan scan QR di meja."
                    );
                    window.location.href = "index.html";
                    return;
                }

                try {
                    const response = await fetch("/api/meja"); // Replace with your API endpoint
                    const data = await response.json();

                    // Find table by kode_barcode
                    const meja = data.find(
                        (m) => m.kode_barcode === kodeBarcode
                    );

                    if (!meja) {
                        alert(
                            "Meja tidak terdaftar di sistem. Silakan hubungi petugas."
                        );
                        window.location.href = "#"; // Or redirect to an error page
                        return;
                    }

                    localStorage.setItem("id_meja", meja.id); // Store actual ID from DB
                    localStorage.setItem("kode_barcode", meja.kode_barcode); // If you want to display it
                    localStorage.removeItem("order_token"); // IMPORTANT: Remove old order_token when a new session starts
                } catch (error) {
                    console.error("Error fetching table data:", error);
                    alert("Gagal memuat data meja. Coba lagi nanti.");
                    window.location.href = "#"; // Or redirect to an error page
                }
            }

            // --- Fetch Menu Data ---
            async function fetchMenuData() {
                let fetchedSuccessfully = false;
                try {
                    allMenus = []; // Clear previous data before fetching
                    const menuResponse = await fetch("/api/menu");
                    if (!menuResponse.ok) {
                        throw new Error(
                            "Failed to fetch menu: " + menuResponse.statusText
                        );
                    }
                    const data = await menuResponse.json();
                    if (!Array.isArray(data)) {
                        throw new Error("Invalid menu data format.");
                    }
                    allMenus = data;
                    fetchedSuccessfully = true;

                    // Extract unique categories from fetched menu data and sort them
                    const uniqueCategoryNames = new Set(
                        allMenus.map((menu) => menu.kategori).filter(Boolean)
                    );
                    allCategories = Array.from(uniqueCategoryNames).sort();

                    // Group subcategories by category
                    const groupedSubcategories = {};
                    allMenus.forEach((menu) => {
                        if (menu.kategori && menu.sub_kategori) {
                            if (!groupedSubcategories[menu.kategori]) {
                                groupedSubcategories[menu.kategori] = new Set();
                            }
                            groupedSubcategories[menu.kategori].add(
                                menu.sub_kategori
                            );
                        }
                    });

                    // Convert sets to sorted arrays and store in allSubcategories object
                    allSubcategories = {};
                    Object.keys(groupedSubcategories)
                        .sort()
                        .forEach((category) => {
                            allSubcategories[category] = Array.from(
                                groupedSubcategories[category]
                            ).sort();
                        });

                    displayCategories();
                    // Initial display of subcategories based on 'all' category
                    displaySubcategories(allMenus); // Pass allMenus to display all subcategories initially, grouped
                    filterMenu(); // Initial display of all menus
                    displayPopularMenus(); // Display popular menus
                } catch (error) {
                    console.error("Error fetching data:", error);
                    // Only show alert if no data was fetched successfully AND allMenus is still empty
                    if (!fetchedSuccessfully && allMenus.length === 0) {
                        alert(
                            "Gagal memuat data menu. Silakan coba refresh halaman."
                        );
                    }
                }
            }

            // --- Fetch Addons Data ---
            async function fetchAddonsData() {
                try {
                    const response = await fetch("/api/addons");
                    if (!response.ok)
                        throw new Error("Failed to fetch add-ons");
                    allAddons = await response.json();
                    if (!Array.isArray(allAddons))
                        throw new Error("Invalid add-ons data");
                    console.log("Add-ons fetched:", allAddons);
                } catch (error) {
                    console.error("Error fetching add-ons:", error);
                    // Optional: display message to user
                }
            }

            // --- Display Categories ---
            function displayCategories() {
                const categoryFilterContainer =
                    document.getElementById("category-filters");
                categoryFilterContainer.innerHTML = "";

                let allButton = document.createElement("button");
                allButton.textContent = "All";
                allButton.classList.add(
                    "px-4",
                    "py-2",
                    "rounded-full",
                    "text-sm",
                    "font-semibold",
                    "transition",
                    "duration-200",
                    "ease-in-out",
                    "active"
                );
                allButton.onclick = () => filterMenuByCategory("all");
                allButton.setAttribute("data-category", "all"); // Add data-category attribute
                categoryFilterContainer.appendChild(allButton);

                allCategories.forEach((categoryName) => {
                    let button = document.createElement("button");
                    button.textContent = categoryName;
                    button.classList.add(
                        "px-4",
                        "py-2",
                        "rounded-full",
                        "text-sm",
                        "font-semibold",
                        "transition",
                        "duration-200",
                        "ease-in-out"
                    );
                    button.onclick = () => filterMenuByCategory(categoryName);
                    button.setAttribute(
                        "data-category",
                        categoryName.toLowerCase()
                    ); // Add data-category attribute
                    categoryFilterContainer.appendChild(button);
                });
            }

            // Display Subcategories - now takes a list of menus to derive subcategories from
            function displaySubcategories(menusToDeriveSubcategories) {
                const subcategoryFilterContainer = document.getElementById(
                    "subcategory-filters"
                );
                subcategoryFilterContainer.innerHTML = "";

                // Group subcategories by category from the provided menusToDeriveSubcategories
                const groupedSubcategoriesForDisplay = {};
                menusToDeriveSubcategories.forEach((menu) => {
                    if (menu.kategori && menu.sub_kategori) {
                        if (!groupedSubcategoriesForDisplay[menu.kategori]) {
                            groupedSubcategoriesForDisplay[menu.kategori] =
                                new Set();
                        }
                        groupedSubcategoriesForDisplay[menu.kategori].add(
                            menu.sub_kategori
                        );
                    }
                });

                const sortedCategoryNames = Object.keys(
                    groupedSubcategoriesForDisplay
                ).sort();

                let allButton = document.createElement("button");
                allButton.textContent = "All";
                allButton.classList.add(
                    "px-4",
                    "py-2",
                    "rounded-full",
                    "text-sm",
                    "font-semibold",
                    "transition",
                    "duration-200",
                    "ease-in-out",
                    "active" // Initially active
                );
                allButton.onclick = () => filterMenuBySubcategory("all");
                allButton.setAttribute("data-subcategory", "all"); // Add data-subcategory attribute
                subcategoryFilterContainer.appendChild(allButton);

                sortedCategoryNames.forEach((categoryName) => {
                    // Create a div for the category heading
                    const categoryHeadingDiv = document.createElement("div");
                    subcategoryFilterContainer.appendChild(categoryHeadingDiv);

                    // Sort subcategories within this category
                    const subcategoriesForDisplay = Array.from(
                        groupedSubcategoriesForDisplay[categoryName]
                    ).sort();

                    subcategoriesForDisplay.forEach((subCategoryName) => {
                        let button = document.createElement("button");
                        button.textContent = subCategoryName;
                        button.classList.add(
                            "px-4",
                            "py-2",
                            "rounded-full",
                            "text-sm",
                            "font-semibold",
                            "transition",
                            "duration-200",
                            "ease-in-out"
                        );
                        button.onclick = () =>
                            filterMenuBySubcategory(subCategoryName);
                        button.setAttribute(
                            "data-subcategory",
                            subCategoryName.toLowerCase()
                        ); // Add data-subcategory attribute
                        subcategoryFilterContainer.appendChild(button);
                    });
                });
            }

            let currentFilterCategory = "all";
            let currentFilterSubcategory = "all"; // Track current subcategory filter

            function filterMenuByCategory(category) {
                currentFilterCategory = category;
                currentFilterSubcategory = "all"; // Reset subcategory filter when main category changes

                // Scroll to top if "All" category is selected
                if (category === "all") {
                    window.scrollTo({ top: 0, behavior: "smooth" });
                }

                // Filter menus by selected category to update subcategory filters
                let menusForSubcategoryFilter = allMenus;
                if (currentFilterCategory !== "all") {
                    menusForSubcategoryFilter = allMenus.filter(
                        (menu) =>
                            menu.kategori &&
                            menu.kategori.toLowerCase() ===
                                currentFilterCategory.toLowerCase()
                    );
                }
                displaySubcategories(menusForSubcategoryFilter); // Update subcategory buttons

                filterMenu(); // Apply all filters

                const categoryButtons = document.querySelectorAll(
                    "#category-filters button"
                );
                categoryButtons.forEach((button) => {
                    const buttonText = button.textContent.toLowerCase();
                    const selectedCategoryLower = category.toLowerCase();

                    if (
                        buttonText === selectedCategoryLower ||
                        (selectedCategoryLower === "all" &&
                            buttonText === "all")
                    ) {
                        button.classList.add("active");
                    } else {
                        button.classList.remove("active");
                    }
                });
                // Reset subcategory buttons active state and scroll 'All' into view
                const subcategoryButtons = document.querySelectorAll(
                    "#subcategory-filters button"
                );
                subcategoryButtons.forEach((button) => {
                    if (button.textContent.toLowerCase() === "all") {
                        button.classList.add("active");
                    } else {
                        button.classList.remove("active");
                    }
                });
            }

            // Filter by Subcategory
            function filterMenuBySubcategory(subCategory) {
                currentFilterSubcategory = subCategory;
                filterMenu();

                const subcategoryButtons = document.querySelectorAll(
                    "#subcategory-filters button"
                );
                subcategoryButtons.forEach((button) => {
                    const buttonText = button.textContent.toLowerCase();
                    const selectedSubcategoryLower = subCategory.toLowerCase();

                    if (
                        buttonText === selectedSubcategoryLower ||
                        (selectedSubcategoryLower === "all" &&
                            buttonText === "all")
                    ) {
                        button.classList.add("active");
                    } else {
                        button.classList.remove("active");
                    }
                });
            }

            // --- Main Filtering Logic (Combines search, category, and subcategory) ---
            function filterMenu() {
                const searchTerm = document
                    .getElementById("menu-search")
                    .value.toLowerCase();
                let filtered = allMenus;

                // 1. Filter by main category
                if (currentFilterCategory !== "all") {
                    filtered = filtered.filter(
                        (menu) =>
                            menu.kategori &&
                            menu.kategori.toLowerCase() ===
                                currentFilterCategory.toLowerCase()
                    );
                }

                // 2. Filter by subcategory (applied to the result of category filter)
                if (currentFilterSubcategory !== "all") {
                    filtered = filtered.filter(
                        (menu) =>
                            menu.sub_kategori &&
                            menu.sub_kategori.toLowerCase() ===
                                currentFilterSubcategory.toLowerCase()
                    );
                }

                // 3. Filter by search term (applied to the result of category and subcategory filters)
                if (searchTerm) {
                    filtered = filtered.filter(
                        (menu) =>
                            menu.nama.toLowerCase().includes(searchTerm) ||
                            (menu.diskripsi &&
                                menu.diskripsi
                                    .toLowerCase()
                                    .includes(searchTerm)) ||
                            (menu.kategori &&
                                menu.kategori
                                    .toLowerCase()
                                    .includes(searchTerm)) ||
                            (menu.sub_kategori && // Include sub_kategori in search
                                menu.sub_kategori
                                    .toLowerCase()
                                    .includes(searchTerm))
                    );
                }
                currentFilteredMenus = filtered; // Store for later use if needed
                displayGroupedMenus(filtered); // Call displayGroupedMenus
            }

            // NEW FUNCTION: displayGroupedMenus
            function displayGroupedMenus(menusToDisplay) {
                const groupedMenuSectionsContainer = document.getElementById(
                    "grouped-menu-sections"
                );
                groupedMenuSectionsContainer.innerHTML = ""; // Clear previous content

                if (menusToDisplay.length === 0) {
                    groupedMenuSectionsContainer.innerHTML =
                        '<p class="text-center text-gray-500 text-lg col-span-full">Tidak ada menu yang ditemukan.</p>';
                    return;
                }

                // Group menus by category first, then by sub_kategori
                // Use a Map to preserve insertion order for categories if needed, but for sorting, object is fine.
                const groupedByCategories = new Map();

                allMenus.forEach((menu) => {
                    const category = menu.kategori || "Lain-lain";
                    if (!groupedByCategories.has(category)) {
                        groupedByCategories.set(category, []);
                    }
                    groupedByCategories.get(category).push(menu);
                });

                // Get sorted category names
                const sortedCategoryNames = Array.from(
                    groupedByCategories.keys()
                ).sort();

                sortedCategoryNames.forEach((categoryName) => {
                    // Filter menus for the current category based on the overall filteredMenus (from search, category, subcategory filters)
                    const menusInCurrentCategory = menusToDisplay.filter(
                        (menu) =>
                            (menu.kategori || "Lain-lain") === categoryName
                    );

                    if (menusInCurrentCategory.length === 0) {
                        return; // Skip if no menus in this category after overall filtering
                    }

                    const groupedBySubcategory = new Map();
                    menusInCurrentCategory.forEach((menu) => {
                        const subcategory = menu.sub_kategori || "Lain-lain";
                        if (!groupedBySubcategory.has(subcategory)) {
                            groupedBySubcategory.set(subcategory, []);
                        }
                        groupedBySubcategory.get(subcategory).push(menu);
                    });

                    const sortedSubcategoryNames = Array.from(
                        groupedBySubcategory.keys()
                    ).sort();

                    sortedSubcategoryNames.forEach((subcategoryName) => {
                        const sectionId = `menu-section-${categoryName
                            .replace(/[^a-zA-Z0-9]/g, "-")
                            .toLowerCase()}-${subcategoryName
                            .replace(/[^a-zA-Z0-9]/g, "-")
                            .toLowerCase()}`;
                        const sectionDiv = document.createElement("section");
                        sectionDiv.id = sectionId;
                        sectionDiv.classList.add("menu-grid-section", "mb-8");
                        sectionDiv.setAttribute(
                            "data-subcategory-name",
                            subcategoryName.toLowerCase()
                        );
                        sectionDiv.setAttribute(
                            "data-category-name",
                            categoryName.toLowerCase()
                        );

                        sectionDiv.innerHTML = `
                            <h3 class="text-2xl font-bold text-gray-800 mb-4 px-4">${subcategoryName}</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 px-4" id="${sectionId}-list">
                                </div>
                        `;
                        groupedMenuSectionsContainer.appendChild(sectionDiv);

                        const subcategoryGrid = document.getElementById(
                            `${sectionId}-list`
                        );
                        // Sort menus within this subcategory by name before rendering
                        const sortedMenusInSubcategory = groupedBySubcategory
                            .get(subcategoryName)
                            .sort((a, b) => a.nama.localeCompare(b.nama));

                        sortedMenusInSubcategory.forEach((menuItem) => {
                            console.log(
                                `Rendering grouped menu item: ${menuItem.nama}, ID: ${menuItem.id}, Kategori: ${menuItem.kategori}, Sub-kategori: ${menuItem.sub_kategori}`
                            );
                            if (
                                typeof menuItem.id === "undefined" ||
                                menuItem.id === null
                            ) {
                                console.warn(
                                    `Skipping grouped menu item '${menuItem.nama}' due to missing or invalid ID.`
                                );
                                return;
                            }

                            const isAvailable =
                                menuItem.stok?.toLowerCase() === "tersedia";
                            const menuDiv = document.createElement("div");
                            menuDiv.classList.add("menu-item");
                            if (!isAvailable) {
                                menuDiv.classList.add("disabled");
                            }
                            menuDiv.onclick = () =>
                                showMenuDetailModal(menuItem);
                            menuDiv.innerHTML = `
                                <img src="/storage/${
                                    menuItem.image_path ?? "default.jpg"
                                }" alt="${
                                menuItem.nama
                            }" class="w-full h-48 object-cover rounded-t-lg">
                                <div class="menu-item-details">
                                    <div>
                                        <h3 class="text-xl font-semibold text-gray-800 mb-2">${
                                            menuItem.nama
                                        }</h3>
                                        <p class="description">${
                                            menuItem.diskripsi
                                        }</p>
                                    </div>
                                    <div class="flex justify-between items-center mt-auto">
                                        <p class="price">Rp ${parseInt(
                                            menuItem.harga
                                        ).toLocaleString("id-ID")}</p>
                                        <button ${
                                            isAvailable ? "" : "disabled"
                                        } class="add-to-order-btn">+</button>
                                    </div>
                                </div>
                            `;
                            subcategoryGrid.appendChild(menuDiv);
                        });
                    });
                });
                setupIntersectionObservers(); // Setup both observers after rendering new sections
            }

            // NEW FUNCTION: displayPopularMenus
            function displayPopularMenus() {
                const popularMenuListContainer =
                    document.getElementById("popular-menu-list");
                popularMenuListContainer.innerHTML = ""; // Clear previous content

                // For demonstration, let's consider the first 5 menus as popular.
                // In a real application, you might have a 'popular' flag in your menu data.
                const popularMenus = allMenus.slice(0, 5); // Take first 5 menus

                if (popularMenus.length === 0) {
                    popularMenuListContainer.innerHTML =
                        '<p class="text-center text-gray-500 col-span-full">Tidak ada menu populer saat ini.</p>';
                    return;
                }

                // Add original items
                popularMenus.forEach((menuItem) => {
                    const isAvailable =
                        menuItem.stok?.toLowerCase() === "tersedia";
                    const menuCardDiv = document.createElement("div");
                    menuCardDiv.classList.add("menu-card"); // Use menu-card class for carousel styling
                    if (!isAvailable) {
                        menuCardDiv.classList.add("disabled");
                    }
                    menuCardDiv.onclick = () => showMenuDetailModal(menuItem);
                    menuCardDiv.innerHTML = `
                        <img src="/storage/${
                            menuItem.image_path ?? "default.jpg"
                        }" alt="${menuItem.nama}">
                        <div class="menu-name">${menuItem.nama}</div>
                        <div class="diskripsi">${menuItem.diskripsi}</div>
                        <div class="harga">Rp ${parseInt(
                            menuItem.harga
                        ).toLocaleString("id-ID")}</div>
                        <div class="actions">
                            <button ${
                                isAvailable ? "" : "disabled"
                            } class="add-btn">+</button>
                        </div>
                    `;
                    popularMenuListContainer.appendChild(menuCardDiv);
                });

                // Clone a few items for infinite loop effect
                // Clone enough items to fill the visible area plus one extra for smooth transition
                const numberOfClones =
                    Math.ceil(
                        popularMenuListContainer.clientWidth /
                            (popularMenuListContainer.children[0]
                                ?.offsetWidth || 160)
                    ) + 1; // Estimate number of visible items + 1
                for (
                    let i = 0;
                    i < popularMenus.length && i < numberOfClones;
                    i++
                ) {
                    const clonedNode =
                        popularMenuListContainer.children[i].cloneNode(true);
                    // Ensure cloned nodes also trigger the modal correctly (re-attach event listener)
                    clonedNode.onclick = () =>
                        showMenuDetailModal(popularMenus[i]);
                    popularMenuListContainer.appendChild(clonedNode);
                }

                // Calculate item width after elements are rendered
                if (popularMenuListContainer.children.length > 0) {
                    popularSliderItemWidth =
                        popularMenuListContainer.children[0].offsetWidth + 16; // width of a card + gap
                }

                // Start auto-slide after rendering
                startPopularSliderAutoSlide();
            }

            // --- Popular Slider Auto-Slide Functions ---
            function startPopularSliderAutoSlide() {
                const popularMenuListContainer =
                    document.getElementById("popular-menu-list");
                if (!popularMenuListContainer) return;

                // Clear any existing interval
                clearInterval(popularSliderInterval);

                popularSliderInterval = setInterval(() => {
                    if (popularSliderPaused) return;

                    popularSliderCurrentPosition += popularSliderItemWidth;
                    popularMenuListContainer.scrollTo({
                        left: popularSliderCurrentPosition,
                        behavior: "smooth",
                    });

                    // Check if we've scrolled past the original items and are now in the cloned section
                    if (
                        popularSliderCurrentPosition >=
                        allMenus.slice(0, 5).length * popularSliderItemWidth
                    ) {
                        setTimeout(() => {
                            // Instantly jump back to the beginning without animation
                            popularMenuListContainer.scrollTo({
                                left: 0,
                                behavior: "auto",
                            });
                            popularSliderCurrentPosition = 0;
                        }, 500); // Give a small delay for the smooth scroll to finish before snapping
                    }
                }, 2000); // Change every 2 seconds

                // Pause on hover/scroll, resume after a delay
                popularMenuListContainer.addEventListener(
                    "mouseenter",
                    () => (popularSliderPaused = true)
                );
                popularMenuListContainer.addEventListener(
                    "mouseleave",
                    () => (popularSliderPaused = false)
                );
                popularMenuListContainer.addEventListener("scroll", () => {
                    popularSliderPaused = true;
                    clearTimeout(popularMenuListContainer.scrollTimeout);
                    popularMenuListContainer.scrollTimeout = setTimeout(() => {
                        popularSliderPaused = false;
                        // When user scrolls, update current position to avoid jumps
                        popularSliderCurrentPosition =
                            popularMenuListContainer.scrollLeft;
                    }, 1000); // Resume 1 second after scroll stops
                });
            }

            // NEW FUNCTION: setupIntersectionObservers for active subcategory and category on scroll
            function setupIntersectionObservers() {
                // Disconnect previous observers if exists
                if (subcategoryObserver) {
                    subcategoryObserver.disconnect();
                }
                if (categoryObserver) {
                    categoryObserver.disconnect();
                }

                // Observer for Subcategories (main grouped sections)
                const subcategoryOptions = {
                    root: null, // viewport
                };

                subcategoryObserver = new IntersectionObserver((entries) => {
                    let activeSubcategoryName = null;
                    let activeCategoryName = null;
                    let maxRatio = 0;

                    // Find the section with the highest intersection ratio
                    entries.forEach((entry) => {
                        if (
                            entry.isIntersecting &&
                            entry.intersectionRatio > maxRatio
                        ) {
                            maxRatio = entry.intersectionRatio;
                            activeSubcategoryName = entry.target.getAttribute(
                                "data-subcategory-name"
                            );
                            activeCategoryName =
                                entry.target.getAttribute("data-category-name");
                        }
                    });

                    // Deactivate all category and subcategory buttons first
                    document
                        .querySelectorAll("#subcategory-filters button")
                        .forEach((btn) => btn.classList.remove("active"));
                    document
                        .querySelectorAll("#category-filters button")
                        .forEach((btn) => btn.classList.remove("active"));

                    if (activeSubcategoryName) {
                        // Activate the corresponding subcategory button
                        const subcategoryButton = document.querySelector(
                            `#subcategory-filters button[data-subcategory="${activeSubcategoryName}"]`
                        );
                        if (subcategoryButton) {
                            subcategoryButton.classList.add("active");
                            // Auto-scroll the active subcategory button into view
                        }

                        // Activate the parent category button based on activeCategoryName
                        if (activeCategoryName) {
                            const categoryButton = document.querySelector(
                                `#category-filters button[data-category="${activeCategoryName}"]`
                            );
                            if (categoryButton) {
                                categoryButton.classList.add("active");
                                // Auto-scroll the active category button into view
                            }
                        }
                    }
                }, subcategoryOptions);

                // Observe all subcategory sections for the main menu grid
                document
                    .querySelectorAll("#grouped-menu-sections section")
                    .forEach((section) => {
                        subcategoryObserver.observe(section);
                    });

                // NOTE: The popular products section (#popular-menu-list) is NOT observed by IntersectionObserver
                // for category/subcategory highlighting, as per your request.
            }

            // --- Menu Detail Modal Functions ---
            function showMenuDetailModal(menuItem) {
                console.log(
                    "showMenuDetailModal called with menuItem:",
                    menuItem
                ); // Debugging: Log the menuItem received
                currentMenuItem = menuItem;
                currentModalQuantity = 1; // Reset quantity
                currentModalNotes = ""; // Reset notes
                currentModalAddons = []; // Reset add-ons

                document.getElementById("modal-menu-image").src = `/storage/${
                    menuItem.image_path ?? "default.jpg"
                }`;
                document.getElementById("modal-menu-name").textContent =
                    menuItem.nama;
                document.getElementById(
                    "modal-menu-price"
                ).textContent = `Rp ${parseInt(menuItem.harga).toLocaleString(
                    "id-ID"
                )}`;
                document.getElementById("modal-menu-description").textContent =
                    menuItem.diskripsi;
                document.getElementById("modal-menu-qty").textContent =
                    currentModalQuantity;
                document.getElementById("modal-menu-notes").value =
                    currentModalNotes;

                // IMPORTANT: Pass menu category to renderAddons
                renderAddons(menuItem.kategori);

                document.getElementById("menu-detail-modal").style.display =
                    "flex";
            }

            function closeMenuDetailModal() {
                document.getElementById("menu-detail-modal").style.display =
                    "none";
                // Reset state so unconfirmed orders are not saved
                currentMenuItem = null;
                currentModalQuantity = 1;
                currentModalNotes = "";
                currentModalAddons = [];
            }

            function changeModalQty(delta) {
                currentModalQuantity += delta;
                if (currentModalQuantity < 1) {
                    currentModalQuantity = 1;
                }
                document.getElementById("modal-menu-qty").textContent =
                    currentModalQuantity;
            }

            // --- Render Addons (Updated for Categories and Subcategories, and no images) ---
            function renderAddons(menuKategori) {
                // Receives menu category
                const addonsContainer = document.getElementById(
                    "modal-addons-container"
                );
                addonsContainer.innerHTML = "";

                // Filter add-ons based on menu category
                let filteredAddons = allAddons;
                if (menuKategori) {
                    filteredAddons = allAddons.filter(
                        (addon) =>
                            addon.kategori &&
                            addon.kategori.toLowerCase() ===
                                menuKategori.toLowerCase()
                    );
                }

                if (filteredAddons.length === 0) {
                    addonsContainer.innerHTML =
                        '<p class="text-gray-500 text-sm col-span-full">Tidak ada add-ons tersedia untuk kategori ini.</p>';
                    return;
                }

                // Group add-ons by category and then by subcategory
                const groupedAddons = filteredAddons.reduce((acc, addon) => {
                    const category = addon.kategori || "Lain-lain"; // Default category
                    const subcategory = addon.sub_kategori || "Umum"; // Default subcategory

                    if (!acc[category]) {
                        acc[category] = {};
                    }
                    if (!acc[category][subcategory]) {
                        acc[category][subcategory] = [];
                    }
                    acc[category][subcategory].push(addon);
                    return acc;
                }, {});

                // Render categories and subcategories
                for (const categoryName in groupedAddons) {
                    const categoryDiv = document.createElement("div");
                    categoryDiv.classList.add("mb-6");
                    categoryDiv.innerHTML = `<h5 class="text-lg font-semibold text-gray-700 mb-3">${categoryName}</h5>`;

                    // Sort subcategories within this category alphabetically
                    const sortedSubcategoryNames = Object.keys(
                        groupedAddons[categoryName]
                    ).sort();

                    sortedSubcategoryNames.forEach((subcategoryName) => {
                        const subcategoryDiv = document.createElement("div");
                        subcategoryDiv.classList.add("mb-4");
                        subcategoryDiv.innerHTML = `<h6 class="text-md font-medium text-gray-600 mb-2 ml-2">${subcategoryName}</h6>`;

                        const addonsGrid = document.createElement("div");
                        addonsGrid.classList.add(
                            "grid",
                            "grid-cols-3",
                            "md:grid-cols-4",
                            "gap-3"
                        ); // Responsive grid for addons

                        // Sort addons within this subcategory alphabetically by name
                        groupedAddons[categoryName][subcategoryName].sort(
                            (a, b) => a.nama.localeCompare(b.nama)
                        );

                        groupedAddons[categoryName][subcategoryName].forEach(
                            (addon) => {
                                const isSelected = currentModalAddons.some(
                                    (a) => a.id === addon.id
                                );
                                const addonDiv = document.createElement("div");
                                // Adjust classes for no-image display, using flex for layout
                                addonDiv.classList.add(
                                    "addon-item",
                                    "flex",
                                    "flex-col",
                                    "justify-center",
                                    "items-center",
                                    "relative",
                                    "flex-shrink-0",
                                    "p-2"
                                );
                                if (isSelected) {
                                    addonDiv.classList.add("selected");
                                }

                                addonDiv.innerHTML = `
                                <div class="addon-name text-center font-medium">${
                                    addon.nama
                                }</div>
                                <div class="addon-price text-sm text-gray-600">Rp ${parseInt(
                                    addon.harga
                                ).toLocaleString("id-ID")}</div>
                                <button class="add-addon-btn ${
                                    isSelected ? "remove" : ""
                                }" onclick="toggleAddon(${addon.id})">
                                    ${isSelected ? "-" : "+"}
                                </button>
                            `;
                                addonsGrid.appendChild(addonDiv);
                            }
                        );
                        subcategoryDiv.appendChild(addonsGrid);
                        categoryDiv.appendChild(subcategoryDiv);
                    });
                    addonsContainer.appendChild(categoryDiv);
                }
            }

            function toggleAddon(addonId) {
                const addon = allAddons.find((a) => a.id === addonId);
                if (!addon) return;

                const existingIndex = currentModalAddons.findIndex(
                    (a) => a.id === addonId
                );

                if (existingIndex > -1) {
                    currentModalAddons.splice(existingIndex, 1);
                } else {
                    currentModalAddons.push(addon);
                }
                renderAddons(currentMenuItem.kategori); // IMPORTANT: Re-call renderAddons with category
            }

            function addCurrentItemToOrder() {
                console.log(
                    "addCurrentItemToOrder called. currentMenuItem before validation:",
                    currentMenuItem
                ); // Debugging: Log currentMenuItem
                // Validate currentMenuItem and its ID before proceeding
                if (
                    !currentMenuItem ||
                    typeof currentMenuItem.id === "undefined" ||
                    currentMenuItem.id === null
                ) {
                    console.error(
                        "Error: currentMenuItem or its ID is invalid. currentMenuItem:",
                        currentMenuItem
                    );
                    alert(
                        "Gagal menambahkan item: Informasi menu tidak lengkap. Mohon pilih menu yang valid."
                    );
                    return; // Stop the function if validation fails
                }

                currentModalNotes = document
                    .getElementById("modal-menu-notes")
                    .value.trim();

                const itemToAdd = {
                    menu_id: currentMenuItem.id,
                    nama: currentMenuItem.nama,
                    harga: parseInt(currentMenuItem.harga) || 0, // Ensure menu price is an integer
                    jumlah: currentModalQuantity,
                    image_path: currentMenuItem.image_path,
                    diskripsi: currentMenuItem.diskripsi,
                    catatan: currentModalNotes, // Add notes
                    addons: currentModalAddons.map((addon) => ({
                        id: addon.id,
                        nama: addon.nama, // Include add-on name
                        harga: parseInt(addon.harga) || 0, // Ensure add-on price is an integer
                    })),
                };

                const existingItemIndex = order.findIndex(
                    (item) =>
                        item.menu_id === itemToAdd.menu_id &&
                        item.catatan === itemToAdd.catatan &&
                        // Compare add-ons based on sorted IDs
                        JSON.stringify(item.addons.map((a) => a.id).sort()) ===
                            JSON.stringify(
                                itemToAdd.addons.map((a) => a.id).sort()
                            )
                );

                if (existingItemIndex > -1) {
                    order[existingItemIndex].jumlah += itemToAdd.jumlah;
                } else {
                    order.push(itemToAdd);
                }

                localStorage.setItem("order_temp", JSON.stringify(order)); // Save order to localStorage
                updateFixedOrderSummary();
                closeMenuDetailModal(); // Close modal after adding to order
            }

            // --- Order Management Functions ---
            function changejumlah(menuId, change) {
                const item = order.find((item) => item.menu_id === menuId);
                if (item) {
                    item.jumlah += change;
                    if (item.jumlah <= 0) {
                        order = order.filter((i) => i.menu_id !== menuId);
                    }
                    localStorage.setItem("order_temp", JSON.stringify(order)); // Save order to localStorage
                    updateOrderSummary();
                    updateFixedOrderSummary();
                }
            }

            function updateOrderSummary() {
                const orderSummary = document.getElementById("order-summary");
                orderSummary.innerHTML = "";

                totalOrderAmount = 0;

                if (order.length === 0) {
                    orderSummary.innerHTML =
                        '<p class="text-center text-gray-500">Pesanan Anda kosong.</p>';
                    return;
                }

                order.forEach((item, index) => {
                    // Calculate item total including add-ons
                    let itemSubtotal =
                        item.jumlah * (parseInt(item.harga) || 0);
                    item.addons.forEach((addon) => {
                        itemSubtotal +=
                            (parseInt(addon.harga) || 0) * item.jumlah; // Add-on price multiplied by main menu quantity
                    });

                    const itemDiv = document.createElement("div");
                    itemDiv.classList.add(
                        "order-summary-item", // Custom class for styling
                        "flex",
                        "items-start", // Align items to the start
                        "mb-4",
                        "pb-4",
                        "border-b",
                        "border-gray-200",
                        "last:border-b-0", // No border for the last item
                        "last:mb-0" // No margin for the last item
                    );
                    itemDiv.innerHTML = `
                        <img src="/storage/${
                            item.image_path ?? "default.jpg"
                        }" alt="${
                        item.nama
                    }" class="w-20 h-20 object-cover rounded-lg mr-4 flex-shrink-0">
                        <div class="flex-grow">
                            <strong class="text-lg text-gray-800">${
                                item.nama
                            }</strong><br>
                            <span class="text-gray-600 text-sm">Rp ${parseInt(
                                item.harga
                            ).toLocaleString("id-ID")}</span>
                            ${
                                item.addons && item.addons.length > 0
                                    ? `<ul class="text-gray-500 text-xs mt-1 list-disc pl-4">` +
                                      item.addons
                                          .map(
                                              (addon) =>
                                                  `<li>+ ${
                                                      addon.nama
                                                  } (Rp ${parseInt(
                                                      addon.harga
                                                  ).toLocaleString(
                                                      "id-ID"
                                                  )})</li>`
                                          )
                                          .join("") +
                                      `</ul>`
                                    : ""
                            }
                            ${
                                item.catatan
                                    ? `<p class="text-gray-500 text-xs mt-1 italic">Catatan: ${item.catatan}</p>`
                                    : ""
                            }
                        </div>
                        <div class="flex flex-col items-end justify-between ml-4">
                            <span class="font-bold text-gray-800 text-lg mb-2">Rp ${itemSubtotal.toLocaleString(
                                "id-ID"
                            )}</span>
                            <div class="flex space-x-2">
                                <button onclick="changejumlah(${
                                    item.menu_id
                                }, -1)"
                                    class="bg-red-100 hover:bg-red-200 text-red-700 font-bold py-1 px-3 rounded-full text-sm transition duration-200">
                                    -
                                </button>
                                <span class="font-bold text-gray-700 text-base">${
                                    item.jumlah
                                }</span>
                                <button onclick="changejumlah(${
                                    item.menu_id
                                }, 1)"
                                    class="bg-green-100 hover:bg-green-200 text-green-700 font-bold py-1 px-3 rounded-full text-sm transition duration-200">
                                    +
                                </button>
                            </div>
                        </div>
                    `;
                    orderSummary.appendChild(itemDiv);
                    totalOrderAmount += itemSubtotal;
                });

                const totalDiv = document.createElement("div");
                totalDiv.classList.add(
                    "mt-4",
                    "pt-4",
                    "border-t",
                    "border-gray-200",
                    "flex",
                    "justify-between",
                    "items-center",
                    "font-bold",
                    "text-2xl",
                    "text-blue-600"
                );
                totalDiv.innerHTML = `
                    <span>Total:</span>
                    <span>Rp ${totalOrderAmount.toLocaleString("id-ID")}</span>
                `;
                orderSummary.appendChild(totalDiv);
            }

            function updateFixedOrderSummary() {
                const fixedSummaryBar = document.getElementById(
                    "fixed-order-summary"
                );
                const summaryText = document.getElementById("summary-text");

                totalOrderAmount = 0;
                order.forEach((item) => {
                    let itemSubtotal =
                        item.jumlah * (parseInt(item.harga) || 0);
                    item.addons.forEach((addon) => {
                        itemSubtotal +=
                            (parseInt(addon.harga) || 0) * item.jumlah;
                    });
                    totalOrderAmount += itemSubtotal;
                });

                if (order.length > 0) {
                    fixedSummaryBar.classList.remove("hidden");
                    summaryText.innerHTML = `Total Pesanan: <span class="font-bold">Rp ${totalOrderAmount.toLocaleString(
                        "id-ID"
                    )}</span>`;
                } else {
                    fixedSummaryBar.classList.add("hidden"); // Hide if order is empty
                    summaryText.innerHTML =
                        'Lihat Pesanan <span class="ml-2">^</span>';
                }
            }

            function showOrderModal() {
                document.getElementById("order-modal").style.display = "flex";
            }

            function showOrderSummaryAndModal() {
                updateOrderSummary();
                showOrderModal();
            }

            function closeModal() {
                document.getElementById("order-modal").style.display = "none";
            }

            function confirmOrderAndNavigate() {
                if (order.length === 0) {
                    alert(
                        "Pesanan Anda kosong. Silakan tambahkan menu terlebih dahulu."
                    );
                    return;
                }

                localStorage.setItem("order_temp", JSON.stringify(order));
                const kodeBarcode = localStorage.getItem("kode_barcode");
                window.location.href = `order.html?kode_barcode=${kodeBarcode}`;
            }

            // Function to toggle search icon visibility
            function toggleSearchIcon() {
                const searchInput = document.getElementById('menu-search');
                const searchIcon = document.getElementById('search-icon');
                if (searchInput.value.length > 0) {
                    searchIcon.style.display = 'none';
                    searchInput.classList.remove('pl-10'); // Remove padding-left when icon is hidden
                    searchInput.classList.add('pl-4'); // Add smaller padding-left
                } else {
                    searchIcon.style.display = 'flex';
                    searchInput.classList.remove('pl-4'); // Restore padding-left when icon is visible
                    searchInput.classList.add('pl-10');
                }
            }

            // --- Initialization ---
            window.onload = function () {
                checkTableNumber();
                fetchMenuData(); // Call function to fetch menu and extract categories
                fetchAddonsData(); // Fetch add-on data
                const storedOrder = localStorage.getItem("order_temp");
                if (storedOrder) {
                    let tempOrder = JSON.parse(storedOrder);
                    order = tempOrder.map((item) => {
                        return {
                            ...item,
                            harga: parseInt(item.harga) || 0, // Ensure menu price is an integer
                            addons: (item.addons || []).map((addon) => ({
                                ...addon,
                                harga: parseInt(addon.harga) || 0, // Ensure add-on price is an integer
                            })),
                        };
                    });
                }
                updateFixedOrderSummary(); // Initial update of the fixed summary bar
                toggleSearchIcon(); // Initial check for search icon visibility on load
                // Removed redundant call to startPopularSliderAutoSlide here, it's called in displayPopularMenus
            };

            // Recalculate popular slider item width on window resize
            window.addEventListener("resize", () => {
                const popularMenuListContainer =
                    document.getElementById("popular-menu-list");
                if (
                    popularMenuListContainer &&
                    popularMenuListContainer.children.length > 0
                ) {
                    popularSliderItemWidth =
                        popularMenuListContainer.children[0].offsetWidth + 16; // Update width of a card + gap
                    // Also reset scroll position to prevent issues if carousel width changes significantly
                    popularMenuListContainer.scrollTo({
                        left: 0,
                        behavior: "auto",
                    });
                    popularSliderCurrentPosition = 0;
                }
                toggleSearchIcon(); // Check search icon visibility on resize
            });

            // --- Event Listener to close modal when clicking outside content ---
            const menuDetailModal =
                document.getElementById("menu-detail-modal");
            menuDetailModal.addEventListener("click", function (event) {
                // If the click target is the modal itself (not content in it)
                if (event.target === menuDetailModal) {
                    closeMenuDetailModal();
                }
            });

            const orderModal = document.getElementById("order-modal");
            orderModal.addEventListener("click", function (event) {
                if (event.target === orderModal) {
                    closeModal();
                }
            });

            // Added scroll event listener for sticky filters
            window.addEventListener("scroll", () => {
                const stickyFilters = document.getElementById(
                    "sticky-filters-container"
                );
                if (stickyFilters) {
                    if (window.scrollY > 50) {
                        // Adjust threshold as needed
                        stickyFilters.classList.add("scrolled");
                    } else {
                        stickyFilters.classList.remove("scrolled");
                    }
                }
            });
        </script>
    </body>
</html>
